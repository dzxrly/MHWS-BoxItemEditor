name: Check Issue Format

on:
  issues:
    types: [ opened ]

permissions:
  issues: write

jobs:
  check-format:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-close lazy bug reports in wrong templates
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = (issue.body || "").toLowerCase();
            const title = (issue.title || "").toLowerCase();
            
            // 1. 定义 Bug Report 模板必须包含的特征字符串
            const bugTemplateSignature = "### Issue Description / 问题描述";
            
            // 2. 检查是否使用了 Bug Report 模板
            const isBugReportTemplate = body.includes(bugTemplateSignature);
            
            // 3. 定义一些典型的 Bug 关键词 (中英双语)
            const bugKeywords = [
              "crash", "error", "exception", "not working", "fail", "bug",
              "崩溃", "报错", "错误", "无法运行", "闪退", "失效"
            ];
            
            // 逻辑判断：
            // 如果 "不是" 标准 Bug 模板，"但是" 内容里包含大量 Bug 关键词 -> 判定为用户选错了模板来报 Bug
            // 注意：为了防止误杀正常的讨论，这里我们只做【警告】或【关闭】。
            // 下面的逻辑是：如果包含关键词且没有模板特征 -> 提示用户
            
            if (!isBugReportTemplate) {
              // 检查是否包含 Bug 关键词
              const hasBugKeywords = bugKeywords.some(keyword => 
                title.includes(keyword) || body.includes(keyword)
              );
            
              if (hasBugKeywords) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: "⚠️ **Format Warning / 格式警告**\n\n" +
                        "It seems you are reporting a bug but not using the **Bug Report** template.\n" +
                        "If this is indeed a bug, please close this issue and open a new one using the correct template to provide versions and logs.\n\n" +
                        "看起来您正在反馈一个 Bug，但没有使用 **Bug report / 问题报告** 模板。\n" +
                        "如果是 Bug，请关闭此 Issue 并使用正确的模板重新提交，以便提供必要的版本和日志信息。"
                });
                // 这里我选择了仅评论（Warning）。如果你想强制关闭，可以取消下面代码的注释：
                /*
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                */
              }
            }